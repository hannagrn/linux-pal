## H12 - Vianselvitys

Hanna Gröndahl

## Järjestelmätiedot

- Rauta: Dell Latitude 7290
- Raudan OS: Windows 10 Pro (10.0.19045)
- Hypervisor: Oracle VM Virtual Box 7.0.6
- Virtuaalikoneen OS: Debian GNU/Linux 11
- Kernel: Linux 5.10.0-20-amd64

## x) Aluksi

Tämän tehtävän tarkoituksena on aiheuttaa vikoja Djangon tuotantoasennukseen, osoittaa vikojen ilmeneminen ja korjata ne. Tehtävän tekeminen alkaa 23.30. Tehtävän alustana toimii [viime harjoituksessa](https://github.com/hannagrn/linux-pal/blob/main/h11.md) käyttämäni virtuaalikone, johon Django on otettu tuotantoon onnistuneesti. Tehtävän teko alkaa 0.00. 

## a) Kirjoitusvirhe Python-tiedostossa

Laitoin virtualenvin päälle komennolla `source env/bin/activate`. Menin kansioon /publicwsgi/hannapp/hannapp ja avasin sieltä microlla settings.py:n. Vaihdoin tein sinne pienen kirjoitusvirheen ja kommentoin oikean komennon talteen. Oletan, että admin-sivu ei näytä tyylitellyltä, jos tämän muuttaa.

![kuva](https://user-images.githubusercontent.com/122886984/222988992-a700f889-83a7-429f-98ad-18e57541f7a5.png)

Koitin ottaa muutoksen käyttöön tekemällä migraatiot, mutta heti `./manage.py makemigrations` antoi virheilmoituksen virheellisestä syntaksista settings.py-tiedostossa. 

![kuva](https://user-images.githubusercontent.com/122886984/222989149-92896044-a738-4a85-af47-0f1cd3a48ad9.png)

Menin takaisin settings.py:hyn, poistin virheellisen komennon ja otin risuaidan oikean komennon edestä pois. Tallensin muutokset, ja nyt `./manage.py makemigrations` sai tulosteeksi "No changes detected", eli lähtötilanteeseen verrattuna tilanne oli sama, sillä aiheuttamaani virhettä ei otettu tuotannossa käyttöön. 

## b) Django-projektikansio väärässä paikassa

Siirsin hannapp-projektikansion publicwsgi:stä wrongway-kansioon `mv /home/hanna/publicwsgi/hannapp/ /home/hanna/wrongway`. Tarkastin, että komento toimi toivotusti tarkastelemalla hakemistojen sisältöjä.

![kuva](https://user-images.githubusercontent.com/122886984/222990317-3b90caad-542a-49a4-bd9e-4cdc4f0c0a3e.png)

Lähtötilanteessa curlaamalla localhostin sai vastaukseksi Not found -virheilmoituksen, mutta nyt otsikkotietojen curlaus `curl -s localhost | grep title` tarjosi 403 Forbidden -virhettä. Sama vastaus tuli myös localhost/admin:sta. `sudo systemctl status apache2` näytti Apache-palvelimen pyörivän iloisesti:

![kuva](https://user-images.githubusercontent.com/122886984/222990650-eb744a26-4ed2-4c28-8309-363336902fce.png)

Apachen error.log näytti kuitenkin, että palvelinmäärittelyt estävät asiakkaan pyynnön.

    [Mon Mar 06 00:55:15.603263 2023] [authz_core:error] [pid 2851:tid 140232437151488] [client 127.0.0.1:53798] AH01630: client denied by  server configuration: /home/hanna/publicwsgi/hannapp
    [Mon Mar 06 00:55:15.691246 2023] [authz_core:error] [pid 2851:tid 140232359933696] [client 127.0.0.1:53798] AH01630: client denied by server configuration: /home/hanna/publicwsgi/hannapp, referer: http://localhost/

Conf-tiedostossahan tosiaan projektikansion paikaksi on määritelty publicwsgi eikä wrongway. Korjaan virheen palauttamalla tiedostopolun sellaiseksi, kuin se on määritelty komennolla `mv wrongway /home/hanna/publicwsgi/hannapp`. Päivitän selaimessa localhostin tarkistaakseni onnistuiko korjaus. Ensin sain Internal server error -virheilmoituksen, joka ei vastannut lähtötilannetta. Käynnistin Apachen uudelleen komennolla `sudo systemctl restart apache2`. Nyt localhostiin tuli odotettu Not found -virheilmoitus, ja admin-sivu toimi jälleen.

## c) Projektikansiolla väärät oikeudet

Otin projektihakemistolta oikeudet komennolla `chmod ugo-rwx hannapp` publicwsgi/hannapp-hakemistossa. Chmod tarkoittaa käyttöoikeuksien hallintaa, ugo rajaa sen, ketä komento koskee ja -rwx tarkoittaa mitkä oikeudet poistetaan. Komento tarkoittaa siis sitä, että hannapp-hakemistossa kukaan ei saa tehdä mitään.  Muutos näkyi selaimen päivittämällä heti localhostissa:

![kuva](https://user-images.githubusercontent.com/122886984/222991497-9564c8ab-27e6-4402-8b21-52ddc2281c59.png)

Tämä siis Not found -virheilmoituksen sijasta. Muutos kirjoitti Apachen error.logiin seuraavasti:

    [Mon Mar 06 01:12:45.439870 2023] [core:error] [pid 2995:tid 140045109417728] (13)Permission denied: [client 127.0.0.1:34264] AH00035: access to /admin/ denied (filesystem path '/home/hanna/publicwsgi/hannapp/hannapp/wsgi.py') because search permissions are missing on a component of the path
    [Mon Mar 06 01:12:45.665241 2023] [core:error] [pid 2995:tid 140045101025024] (13)Permission denied: [client 127.0.0.1:34264] AH00035: access to /favicon.ico denied (filesystem path '/home/hanna/publicwsgi/hannapp/hannapp/wsgi.py') because search permissions are missing on a component of the path, referer: http://localhost/admin/
    [Mon Mar 06 01:14:08.208437 2023] [core:error] [pid 2995:tid 140045075846912] (13)Permission denied: [client 127.0.0.1:42468] AH00035: access to / denied (filesystem path '/home/hanna/publicwsgi/hannapp/hannapp/wsgi.py') because search permissions are missing on a component of the path
   
Pääsy resursseihin estettiin, koska wsgi.py:tä ei voi suorittaa. Palautin oikeuksia ensin vähemmän komennolla `u+rwx`, mutta se ei riittänyt, koska selain näytti localhost/adminissa 403 Forbidden -virheilmoitusta. Korjasin oikeudet kohdalleen antamalla lisää oikeuksia `ugo+rwx`. Pohdin, että en ole aivan varma siitä, oliko kaikilla ryhmillä tosiaan rwx-oikeudet alkutilanteessa, koska ne kuulostavat aika laajoilta oikeuksilta. Nyt localhostissa oli tuttu Not found ja admin näkyi selaimessa toivotulla tavalla.

![kuva](https://user-images.githubusercontent.com/122886984/222992480-e37216d7-3805-46ff-b5a0-91858a354541.png)

01:35 tehtävän tekeminen päättyi tältä päivältä.
